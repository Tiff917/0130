<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comments</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: #262626; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed; /* 防止背景內容隨鍵盤彈出而亂跳 */
            width: 100%;
        }

        /* 頂部導航列 */
        .header {
            height: 50px; border-bottom: 1px solid #dbdbdb;
            display: flex; align-items: center; padding: 0 16px;
            font-weight: 600; font-size: 16px; justify-content: space-between;
            background: white; flex-shrink: 0;
        }
        .back-btn { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;}
        
        /* 留言列表區 */
        .content { 
            flex: 1; overflow-y: auto; padding: 16px; 
            overscroll-behavior-y: contain; /* 優化滑動體驗 */
        }
        
        /* 第一則留言 (Caption) */
        .caption-block { display: flex; gap: 12px; padding-bottom: 12px; border-bottom: 1px solid #efefef; margin-bottom: 12px; }
        .caption-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #dbdbdb; flex-shrink: 0; }
        .caption-text-area { flex: 1; font-size: 14px; line-height: 1.4; }
        
        /* 一般留言 */
        .comment-row { display: flex; gap: 12px; margin-bottom: 16px; }
        .comment-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #dbdbdb; flex-shrink: 0; }
        .comment-user { font-weight: 600; margin-right: 5px; }
        .comment-text-block { font-size: 14px; line-height: 1.4; }
        .time-text { font-size: 12px; color: #8e8e8e; margin-top: 4px; display: block; }

        /* 底部輸入框 */
        .footer {
            border-top: 1px solid #dbdbdb; padding: 10px 16px;
            display: flex; align-items: center; background: white;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            flex-shrink: 0;
        }
        .user-avatar-small { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; object-fit: cover; background: #dbdbdb;}
        .comment-input { flex: 1; border: none; font-size: 14px; padding: 8px 0; background: transparent; }
        .post-btn { color: #bfa093; font-weight: 600; font-size: 14px; border: none; background: none; cursor: pointer; padding-left: 10px; opacity: 0.5; pointer-events: none; }
        .post-btn.active { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>

    <div class="header">
        <div class="back-btn" onclick="goBackToSocial()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </div>
        <span>Comments</span>
        <div style="width: 30px;"></div>
    </div>

    <div class="content" id="comments-list">
        <div style="text-align:center; margin-top:50px; color:#999;">Loading...</div>
    </div>

    <div class="footer">
        <img src="" class="user-avatar-small" id="my-avatar">
        <input type="text" class="comment-input" id="input-box" placeholder="Add a comment..." autocomplete="off">
        <button class="post-btn" id="post-btn">Post</button>
    </div>

    <script>
    // --- 全域變數與資料庫邏輯 (保持您的邏輯) ---
    const dbName = "MemoriesDB";
    let db;
    let userAvatarUrl = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
    let currentPost = null;

    const params = new URLSearchParams(window.location.search);
    const rawId = params.get('id');
    const postId = rawId ? Number(rawId) : null; 

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 8);
            request.onsuccess = (e) => { db = e.target.result; resolve(db); };
            request.onerror = (e) => reject(e);
        });
    }

    async function init() {
        if (postId === null || isNaN(postId)) {
            document.getElementById('comments-list').innerHTML = '<div style="text-align:center; margin-top:20px; color:#8C735D;">Invalid Post ID</div>';
            return;
        }
        try {
            await initDB();
            await loadUserProfile();
            await loadPostData(); 
        } catch (err) { console.error(err); }
    }

    function loadUserProfile() {
        return new Promise((resolve) => {
            const tx = db.transaction("user_profile", "readonly");
            const req = tx.objectStore("user_profile").get("avatar");
            req.onsuccess = (e) => {
                const res = e.target.result;
                if (res && (res instanceof Blob || res instanceof File)) {
                    if (userAvatarUrl.startsWith('blob:')) URL.revokeObjectURL(userAvatarUrl);
                    userAvatarUrl = URL.createObjectURL(res);
                }
                document.getElementById('my-avatar').src = userAvatarUrl;
                resolve();
            };
            req.onerror = () => resolve(); 
        });
    }

    function loadPostData() {
        return new Promise((resolve) => {
            const tx = db.transaction("posts_timeline", "readonly");
            const store = tx.objectStore("posts_timeline");
            const request = store.get(postId);
            request.onsuccess = (e) => {
                currentPost = e.target.result;
                if (currentPost) renderComments();
                else document.getElementById('comments-list').innerHTML = '<div style="text-align:center; margin-top:20px;">Memory not found.</div>';
                resolve();
            };
            request.onerror = () => resolve();
        });
    }

    function renderComments() {
        const list = document.getElementById('comments-list');
        const storedName = localStorage.getItem('myProfileName') || "Me";
        if (!currentPost.comments) currentPost.comments = [];
        let html = '';

        if (currentPost.comments.length > 0) {
            const firstCommentText = currentPost.comments[0].text;
            const isPlaceholder = firstCommentText === "Share a memory..." || firstCommentText === "No description.";
            if (firstCommentText && !isPlaceholder) {
                html += `<div class="caption-block"><img src="${userAvatarUrl}" class="caption-avatar"><div class="caption-text-area"><span class="comment-user">${storedName}</span><span style="white-space: pre-wrap;">${firstCommentText}</span><div class="time-text">${new Date(currentPost.timestamp).toLocaleString()}</div></div></div>`;
            }
        }

        if (currentPost.comments.length > 1) {
            for (let i = 1; i < currentPost.comments.length; i++) {
                const c = currentPost.comments[i];
                let avatarSrc = (c.user === storedName) ? userAvatarUrl : `https://i.pravatar.cc/150?u=${encodeURIComponent(c.user)}`;
                html += `<div class="comment-row"><img src="${avatarSrc}" class="comment-avatar"><div class="comment-text-block"><span class="comment-user">${c.user}</span><span>${c.text}</span></div></div>`;
            }
        } else if (html === '') {
            html = `<div style="text-align:center; color:#ccc; font-size:12px; margin-top:20px;">No comments yet.</div>`;
        }
        list.innerHTML = html;
        setTimeout(() => { list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' }); }, 100);
    }

    const input = document.getElementById('input-box');
    const btn = document.getElementById('post-btn');
    input.oninput = () => { btn.classList.toggle('active', input.value.trim().length > 0); };
    btn.onclick = submitComment;
    input.onkeypress = (e) => { if (e.key === 'Enter') submitComment(); };

    function submitComment() {
        const text = input.value.trim();
        if (!text || !currentPost) return;
        const storedName = localStorage.getItem('myProfileName') || "Me";
        if (!currentPost.comments) currentPost.comments = [];
        currentPost.comments.push({ user: storedName, text: text });
        const tx = db.transaction(["posts_timeline"], "readwrite");
        tx.objectStore("posts_timeline").put(currentPost);
        tx.oncomplete = () => {
            input.value = '';
            btn.classList.remove('active');
            new BroadcastChannel('memory_update').postMessage('updated');
            renderComments();
        };
    }

    // --- ★ 關鍵修正 2：確保返回邏輯強制跳轉到最外層 index.html ★ ---
    function goBackToSocial() {
        // 先解鎖滑動，避免跳轉後狀態殘留
        window.parent.postMessage('unlockSwiping', '*');
        // 強制頂層視窗跳轉回首頁軌道
        window.top.location.href = 'index.html?tab=social';
    }

    // PWA 外殼鎖定通訊
    window.parent.postMessage('lockSwiping', '*');
    window.addEventListener('beforeunload', () => {
        window.parent.postMessage('unlockSwiping', '*');
    });

    init();
    </script>
</body>
</html>